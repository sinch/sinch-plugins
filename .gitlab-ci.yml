# yaml-language-server: $schema=https://gitlab.com/gitlab-org/gitlab/-/raw/master/app/assets/javascripts/editor/schema/ci.json
# ================================
# GitLab CI Variables Reference
# ================================
# Required variables (set in Settings ‚Üí CI/CD ‚Üí Variables):
#   GITHUB_PAT_2 - Personal Access Token with for synching with GitHub repos (MUST be kept secret)
#   GITHUB_REPO_URL - GitHub repository URL (e.g., github.com/sinch/sinch-plugins)
#
# Predefined GitLab CI variables (automatically available):
#   CI_COMMIT_SHORT_SHA   - Short commit SHA (first 8 chars)
#   CI_COMMIT_REF_NAME    - Branch or tag name
#   CI_COMMIT_REF_SLUG    - Branch name slugified for URLs
#   CI_COMMIT_TAG         - Git tag (if pipeline triggered by tag)
#   GITLAB_USER_EMAIL     - Email of user who triggered pipeline
#   GITLAB_USER_NAME      - Name of user who triggered pipeline
#   CI_PROJECT_URL        - GitLab project URL
#   CI_JOB_ID             - Unique job ID
#   CI_JOB_TOKEN          - GitLab job token (used for git authentication)
#   CI_SERVER_HOST        - GitLab server hostname (e.g., gitlab.com)
#   CI_PROJECT_PATH       - Project path (group/project)
# ================================
# Pipeline-level inputs specification
spec:
  inputs:
    version_bump_type:
      description: "Select which version bump to apply. Version bump type: patch (0.0.X), minor (0.X.0), major (X.0.0), or none (skip bump)"
      type: string
      default: "patch"
      options:
        - patch
        - minor
        - major
        - none
---
default:
  tags:
    - saas
    - general
    - eu-west-1
    # Arch is especially important
    - arm64

stages:
  - pre-release
  - github-sync

# ================================
# Stage 1 - Bump Version
# ================================
version-bump:
  stage: pre-release
  image: alpine:latest
  before_script:
    - apk add --no-cache git jq
    - |
      echo "üîê Configuring Git authentication..."
      git config --global user.email "${GITLAB_USER_EMAIL:-ci@sinch.com}"
      git config --global user.name "${GITLAB_USER_NAME:-CI Release Bot}"
  script:
    - BUMP_TYPE="$[[ inputs.version_bump_type ]]"
    - echo "Bump type is $BUMP_TYPE"
    - if [ "$BUMP_TYPE" = "none" ]; then echo "Skipping version bump"; exit 0; fi

    # Set up Git credentials using GitLab's CI_JOB_TOKEN with write access
    # Note: Requires Settings -> CI/CD -> Job Token Permissions -> Allow Git push requests to the repository
    - git remote set-url origin "https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    - git checkout $CI_COMMIT_REF_NAME
    - git pull origin $CI_COMMIT_REF_NAME

    - PLUGIN_FILE="plugins/sinch-claude-plugin/.claude-plugin/plugin.json"
    - CURRENT_VERSION=$(jq -r .version $PLUGIN_FILE)
    - echo "Current version $CURRENT_VERSION"

    - |
      major=$(echo "$CURRENT_VERSION" | cut -d. -f1)
      minor=$(echo "$CURRENT_VERSION" | cut -d. -f2)
      patch=$(echo "$CURRENT_VERSION" | cut -d. -f3)
      if [ "$BUMP_TYPE" = "major" ]; then
        major=$((major + 1)); minor=0; patch=0
      elif [ "$BUMP_TYPE" = "minor" ]; then
        minor=$((minor + 1)); patch=0
      else
        patch=$((patch + 1))
      fi
      NEW_VERSION="$major.$minor.$patch"
      echo "New version: $NEW_VERSION"
      echo "$NEW_VERSION" > version.txt

    - NEW_VERSION=$(cat version.txt)
    - jq --arg v "$NEW_VERSION" '.version = $v' $PLUGIN_FILE > tmp.json && mv tmp.json $PLUGIN_FILE

    - git add $PLUGIN_FILE
    - 'git commit -m "ci(release): ${NEW_VERSION} [skip ci]"'
    - git push origin HEAD:$CI_COMMIT_REF_NAME
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE == "push"
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE == "web"

# ================================
# Stage 2 - Sync [main] branch to GitHub
# ================================
# We only using git push [main] --force here instead of a full mirror push to avoid
# cloning internal branches or tags that are not meant to be pushed to GitHub.
sync_to_github:
  stage: github-sync
  image:
    name: alpine/git:latest
    entrypoint: [""]
  needs:
    - job: version-bump
      artifacts: false
  before_script:
    # Configure Git with CI_JOB_TOKEN authentication
    - |
      echo "üîê Configuring Git authentication..."
      git config --global user.email "${GITLAB_USER_EMAIL:-ci@sinch.com}"
      git config --global user.name "${GITLAB_USER_NAME:-CI Release Bot}"
  script:
    # 1. create a fresh clone to avoid messing up the runner's cache or current workspace
    - git clone $CI_REPOSITORY_URL repo_to_sync
    - cd repo_to_sync

    # 2. Add the GitHub remote with the token embedded
    - git remote add github https://x-access-token:${GITHUB_PAT_2}@${GITHUB_REPO_URL}

    # 3. Push [main] to GitHub
    - git checkout main
    # 4. Remove .gitlab-ci.yml from final GitHub repo
    - git rm --ignore-unmatch .gitlab-ci.yml
    - git commit --amend --no-edit
    - git push github main --force
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE == "push"
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE == "web"
